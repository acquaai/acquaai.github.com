<!DOCTYPE html>
<html lang="en">
  <head><meta name="generator" content="Hexo 3.9.0">
    
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="SonarQube on Kubernetes">













  <link rel="alternate" href="https://acquaai.github.io/atom.xml" title="Acqua">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0">



<link rel="canonical" href="https://acquaai.github.io/2018/03/23/sonar/">


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0">






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> SonarQube on Kubernetes - Acqua </title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">Acqua</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            Home
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            Archives
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            About
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Acqua</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              Home
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              Archives
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              About
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          SonarQube on Kubernetes
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-03-23
        </span>
        
          <div class="post-category">
            
              <a href="/categories/DevOps/">DevOps</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-postgresql"><span class="toc-text"> 安装 PostgreSQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-postgresql-secret"><span class="toc-text"> 创建 PostgreSQL Secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#部署-postgresql"><span class="toc-text"> 部署 PostgreSQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署-sonarqube"><span class="toc-text"> 部署 Sonarqube</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sonarqube-plugins"><span class="toc-text"> SonarQube Plugins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sonarqube-scanner"><span class="toc-text"> SonarQube Scanner</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jenkins集成sonarqube"><span class="toc-text"> Jenkins集成Sonarqube</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <blockquote>
<p>本文中PostgreSQL使用 <a href="https://acquaai.github.io/2019/09/16/using-ceph-rbd-persistent-storage/">Ceph RBD</a> 作为持久卷，SonarQube使用 NFS 作为持久卷。</p>
</blockquote>
<h2 id="安装-postgresql"><a class="markdownIt-Anchor" href="#安装-postgresql"></a> 安装 PostgreSQL</h2>
<h3 id="创建-postgresql-secret"><a class="markdownIt-Anchor" href="#创建-postgresql-secret"></a> 创建 PostgreSQL Secret</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n sonar | base64</span><br><span class="line">c29uYXI=</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -n Passw0rd | base64</span><br><span class="line">UGFzc3cwcmQ=</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> -n sonardb | base64</span><br><span class="line">c29uYXJkYg==</span><br><span class="line"></span><br><span class="line"><span class="comment">#与 echo -n 作用相同</span></span><br><span class="line">$ tr --delete <span class="string">'\n'</span> &lt; mysql-root-pwd.txt &gt; .strippedmysql-root-pwd.txt &amp;&amp; mv .strippedmysql-root-pwd.txt mysql-root-pwd.txt</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line">$ kubectl create secret generic mysql-secrets --from-literal=root-user=root --from-literal=root-password=Passw0rd --from-literal=mysql-database=sonardb --from-literal=mysql-user=sonar --from-literal=mysql-password=sonar -n sonar</span><br><span class="line"></span><br><span class="line">OR</span><br><span class="line">$ kubectl create secret generic mysql-root-pwd --from-file=mysql-root-pwd.txt -n sonar</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat pg-secrets.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: postgres-secrets</span><br><span class="line">  namespace: sonar</span><br><span class="line">  labels:</span><br><span class="line">    app: postgres</span><br><span class="line">data:</span><br><span class="line">  postgres-db: c29uYXJkYg==</span><br><span class="line">  postgres-user: c29uYXI=</span><br><span class="line">  postgres-password: c29uYXI=</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pg-secrets.yaml</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get secrets -n sonar</span><br><span class="line">NAME                  TYPE                                  DATA      AGE</span><br><span class="line">ceph-secret           kubernetes.io/rbd                     1         8d</span><br><span class="line">default-token-fzbwt   kubernetes.io/service-account-token   3         16d</span><br><span class="line">postgres-secrets      Opaque                                3         3d</span><br><span class="line"></span><br><span class="line">$ kubectl describe secrets/postgres-secrets  -n sonar</span><br><span class="line">Name:         postgres-secrets</span><br><span class="line">Namespace:    sonar</span><br><span class="line">Labels:       app=postgres</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Type:  Opaque</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">postgres-db:        7 bytes</span><br><span class="line">postgres-password:  5 bytes</span><br><span class="line">postgres-user:      5 bytes</span><br></pre></td></tr></table></figure>
<h3 id="部署-postgresql"><a class="markdownIt-Anchor" href="#部署-postgresql"></a> 部署 PostgreSQL</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ cat pg-statefulset.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: postgres</span><br><span class="line">  namespace: sonar</span><br><span class="line">  labels:</span><br><span class="line">    app: postgres</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 5432</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: postgres</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1beta1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: postgres</span><br><span class="line">  namespace: sonar</span><br><span class="line">  labels:</span><br><span class="line">    app: postgres</span><br><span class="line">spec:</span><br><span class="line">  serviceName: postgres</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: postgres</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 10</span><br><span class="line">      containers:</span><br><span class="line">      - name: postgresql</span><br><span class="line">        image: 10.0.77.16/library/postgres:10.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5432</span><br><span class="line">          name: postgresql</span><br><span class="line">        env:</span><br><span class="line">        - name: POSTGRES_USER</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: postgres-secrets</span><br><span class="line">              key: postgres-user</span><br><span class="line">        - name: POSTGRES_DB</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: postgres-secrets</span><br><span class="line">              key: postgres-db</span><br><span class="line">        - name: POSTGRES_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: postgres-secrets</span><br><span class="line">              key: postgres-password</span><br><span class="line">        - name: PGDATA</span><br><span class="line">          value: /var/lib/postgresql/data/pgdata</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: postgres-volume</span><br><span class="line">          mountPath: /var/lib/postgresql/data</span><br><span class="line">      imagePullSecrets: </span><br><span class="line">        - name: registrykey</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: postgres-volume</span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">        - ReadWriteOnce</span><br><span class="line">      storageClassName: ceph-postgres</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 10Gi</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pg-statefulset.yaml</span><br></pre></td></tr></table></figure>
<blockquote>
<p>volumeClaimTemplates中定义了PVC，并指定了<code>storageClassName: &quot;ceph-postgres&quot;</code>，会根据PVC动态创建Pod所需的PV。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc -n sonar</span><br><span class="line">NAME                         STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS    AGE</span><br><span class="line">postgres-volume-postgres-0   Bound     pvc-df69da97-2e7a-11e8-b7b9-0050568879ea   10Gi       RWO            ceph-postgres   5m</span><br><span class="line"></span><br><span class="line">$ kubectl get pv -n sonar</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                              STORAGECLASS    REASON    AGE</span><br><span class="line">pvc-df69da97-2e7a-11e8-b7b9-0050568879ea   10Gi       RWO            Delete           Bound     sonar/postgres-volume-postgres-0   ceph-postgres             7m</span><br><span class="line"></span><br><span class="line">$ kubectl describe persistentvolume  pvc-df69da97-2e7a-11e8-b7b9-0050568879ea</span><br><span class="line">Name:            pvc-df69da97-2e7a-11e8-b7b9-0050568879ea</span><br><span class="line">Labels:          &lt;none&gt;</span><br><span class="line">Annotations:     kubernetes.io/createdby=rbd-dynamic-provisioner</span><br><span class="line">                 pv.kubernetes.io/bound-by-controller=yes</span><br><span class="line">                 pv.kubernetes.io/provisioned-by=kubernetes.io/rbd</span><br><span class="line">StorageClass:    ceph-postgres</span><br><span class="line">Status:          Bound</span><br><span class="line">Claim:           sonar/postgres-volume-postgres-0</span><br><span class="line">Reclaim Policy:  Delete</span><br><span class="line">Access Modes:    RWO</span><br><span class="line">Capacity:        10Gi</span><br><span class="line">Message:         </span><br><span class="line">Source:</span><br><span class="line">    Type:          RBD (a Rados Block Device mount on the host that shares a pod<span class="string">'s lifetime)</span></span><br><span class="line"><span class="string">    CephMonitors:  [10.0.77.17:6789]</span></span><br><span class="line"><span class="string">    RBDImage:      kubernetes-dynamic-pvc-df734e53-2e7a-11e8-93af-00505688047e</span></span><br><span class="line"><span class="string">    FSType:        xfs</span></span><br><span class="line"><span class="string">    RBDPool:       rbd</span></span><br><span class="line"><span class="string">    RadosUser:     admin</span></span><br><span class="line"><span class="string">    Keyring:       /etc/ceph/keyring</span></span><br><span class="line"><span class="string">    SecretRef:     &amp;&#123;ceph-secret &#125;</span></span><br><span class="line"><span class="string">    ReadOnly:      false</span></span><br><span class="line"><span class="string">Events:            &lt;none&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="部署-sonarqube"><a class="markdownIt-Anchor" href="#部署-sonarqube"></a> 部署 Sonarqube</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">$ cat sonar-rc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: sonar</span><br><span class="line">  namespace: sonar</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 30001</span><br><span class="line">  selector:</span><br><span class="line">    name: sonar</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ReplicationController</span><br><span class="line">metadata:</span><br><span class="line">  name: sonar</span><br><span class="line">  namespace: sonar</span><br><span class="line">  labels:</span><br><span class="line">    name: sonar</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    name: sonar</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: sonar</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: sonar</span><br><span class="line">        image: 10.0.77.16/library/sonarqube:6.7</span><br><span class="line">        env:</span><br><span class="line">        - name: SONARQUBE_JDBC_USERNAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: postgres-secrets</span><br><span class="line">              key: postgres-user</span><br><span class="line">        - name: SONARQUBE_JDBC_PASSWORD</span><br><span class="line">          valueFrom:</span><br><span class="line">            secretKeyRef:</span><br><span class="line">              name: postgres-secrets</span><br><span class="line">              key: postgres-password</span><br><span class="line">        - name: SONARQUBE_JDBC_URL</span><br><span class="line">          value: jdbc:postgresql://postgres:5432/sonardb</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: "/opt/sonarqube/conf"</span><br><span class="line">          name: sonar-conf</span><br><span class="line">        - mountPath: "/opt/sonarqube/data"</span><br><span class="line">          name: sonar-data</span><br><span class="line">        - mountPath: "/opt/sonarqube/extensions"</span><br><span class="line">          name: sonar-extensions</span><br><span class="line">        - mountPath: "/opt/sonarqube/logs"</span><br><span class="line">          name: sonar-logs</span><br><span class="line">      volumes:</span><br><span class="line">        - name: sonar-conf</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.0.77.16</span><br><span class="line">            path: "/nfs/sonar/conf"</span><br><span class="line">        - name: sonar-data</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.0.77.16</span><br><span class="line">            path: "/nfs/sonar/data"</span><br><span class="line">        - name: sonar-extensions</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.0.77.16</span><br><span class="line">            path: "/nfs/sonar/extensions"</span><br><span class="line">        - name: sonar-logs</span><br><span class="line">          nfs:</span><br><span class="line">            server: 10.0.77.16</span><br><span class="line">            path: "/nfs/sonar/logs"</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f sonar-rc.yaml</span><br></pre></td></tr></table></figure>
<p>使用默认用户、密码 admin/admin 访问SonarQube <a href="http://k8s-node-ip:30001" target="_blank" rel="noopener">http://k8s-node-ip:30001</a></p>
<h2 id="sonarqube-plugins"><a class="markdownIt-Anchor" href="#sonarqube-plugins"></a> SonarQube Plugins</h2>
<p><a href="https://docs.sonarqube.org/display/PLUG" target="_blank" rel="noopener">Plugin Library</a></p>
<p>SonarQube v6.7预装好的Plugins如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n sonar</span><br><span class="line">NAME          READY     STATUS    RESTARTS   AGE</span><br><span class="line">postgres-0    1/1       Running   0          15h</span><br><span class="line">sonar-wmvnf   1/1       Running   0          15h</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -n sonar sonar-wmvnf -it -- bash</span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube/extensions/plugins<span class="comment"># ls -l</span></span><br><span class="line">total 40464</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 2703958 Nov  6 08:12 sonar-csharp-plugin-6.5.0.3766.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 1618672 Nov  6 08:12 sonar-flex-plugin-2.3.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 6759535 Nov  6 15:31 sonar-java-plugin-4.15.0.12310.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 3355702 Nov  6 08:12 sonar-javascript-plugin-3.2.0.5506.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 3022870 Nov  6 16:50 sonar-php-plugin-2.11.0.2485.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 4024311 Nov  6 08:12 sonar-python-plugin-1.8.0.1496.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 3625962 Nov  6 08:12 sonar-scm-git-plugin-1.3.0.869.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 6680471 Nov  6 08:12 sonar-scm-svn-plugin-1.6.0.860.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 2250667 Nov  6 08:12 sonar-typescript-plugin-1.1.0.1079.jar</span><br><span class="line">-rw-r--r-- 1 sonarqube sonarqube 7368250 Nov  6 08:12 sonar-xml-plugin-1.4.3.1027.jar</span><br></pre></td></tr></table></figure>
<h2 id="sonarqube-scanner"><a class="markdownIt-Anchor" href="#sonarqube-scanner"></a> SonarQube Scanner</h2>
<p><a href="https://docs.sonarqube.org/display/SCAN/Analyzing+with+SonarQube+Scanner" target="_blank" rel="noopener">Analyzing with SonarQube Scanner</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@sonar-wmvnf:~<span class="comment"># cd /opt/sonarqube/extensions/downloads</span></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube/extensions/downloads<span class="comment"># wget https://sonarsource.bintray.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.1.0.1141-linux.zip</span></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube/extensions/downloads<span class="comment"># unzip sonar-scanner-cli-3.1.0.1141-linux.zip -d /opt/sonarqube</span></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube<span class="comment"># mv sonar-scanner-3.1.0.1141-linux sonar-scanner</span></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube<span class="comment"># chown -R sonarqube:sonarqube sonar-scanner/</span></span><br></pre></td></tr></table></figure>
<p>增加 SonarQube Scanner 的环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cp sonar/sonar-wmvnf:/etc/profile ./</span><br><span class="line">tar: Removing leading `/<span class="string">' from member names</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">$ vi profile</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">/opt/sonarqube/sonar-scanner/bin</span></span><br><span class="line"><span class="string">......</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cp ./profile sonar/sonar-wmvnf:/etc/</span><br><span class="line"></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube<span class="comment"># source /etc/profile</span></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube<span class="comment"># sonar-scanner -h</span></span><br><span class="line">INFO: </span><br><span class="line">INFO: usage: sonar-scanner [options]</span><br><span class="line">INFO: </span><br><span class="line">INFO: Options:</span><br><span class="line">INFO:  -D,--define &lt;arg&gt;     Define property</span><br><span class="line">INFO:  -h,--<span class="built_in">help</span>             Display <span class="built_in">help</span> information</span><br><span class="line">INFO:  -v,--version          Display version information</span><br><span class="line">INFO:  -X,--debug            Produce execution debug output</span><br></pre></td></tr></table></figure>
<p>配置 SonarQube Scanner 属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat sonar-scanner.properties</span><br><span class="line"></span><br><span class="line">sonar.host.url=http://localhost:9000</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl cp ./sonar-scanner.properties sonar/sonar-wmvnf:/opt/sonarqube/sonar-scanner/conf/sonar-scanner.properties</span><br></pre></td></tr></table></figure>
<p>配置 Python 代码分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat sonar-project.properties</span><br><span class="line">sonar.projectKey=my:python</span><br><span class="line">sonar.projectName=python</span><br><span class="line">sonar.projectVersion=1.0</span><br><span class="line">sonar.sources=.</span><br><span class="line">sonar.sourceEncoding=UTF-8</span><br><span class="line"></span><br><span class="line">sonar.language=py</span><br><span class="line"><span class="comment">#sonar.python.pylint=/usr/bin/pylint</span></span><br><span class="line"><span class="comment">#sonar.python.pylint_config=.pylintrc</span></span><br><span class="line"><span class="comment">#sonar.python.pylint.reportPath=./pylint-report.txt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@sonar-wmvnf:/opt/sonarqube/conf<span class="comment"># mkdir python</span></span><br><span class="line"></span><br><span class="line">$ kubectl cp ./sonar-project.properties sonar/sonar-wmvnf:/opt/sonarqube/conf/python/sonar-project.properties</span><br><span class="line"></span><br><span class="line">root@sonar-wmvnf:/opt/sonarqube/conf<span class="comment"># chown -R sonarqube:sonarqube python</span></span><br></pre></td></tr></table></figure>
<p>执行分析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@sonar-wmvnf:/opt/sonarqube/conf/python<span class="comment"># sonar-scanner -Dsonar.projectKey=my:python -Dsonar.sources=.</span></span><br><span class="line"></span><br><span class="line">INFO: Scanner configuration file: /opt/sonarqube/sonar-scanner/conf/sonar-scanner.properties</span><br><span class="line">INFO: Project root configuration file: /opt/sonarqube/conf/python/sonar-project.properties</span><br><span class="line">INFO: SonarQube Scanner 3.1.0.1141</span><br><span class="line">......</span><br><span class="line">......</span><br><span class="line">INFO: ANALYSIS SUCCESSFUL, you can browse http://localhost:9000/dashboard/index/my:python</span><br><span class="line">INFO: Note that you will be able to access the updated dashboard once the server has processed the submitted analysis report</span><br><span class="line">INFO: More about the report processing at http://localhost:9000/api/ce/task?id=AWJW_N6U1qxTjZHyQmBu</span><br><span class="line">INFO: Task total time: 4.424 s</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br><span class="line">INFO: EXECUTION SUCCESS</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br><span class="line">INFO: Total time: 6.144s</span><br><span class="line">INFO: Final Memory: 11M/335M</span><br><span class="line">INFO: ------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p><img src="/images/sonarPython.png" alt></p>
<h2 id="jenkins集成sonarqube"><a class="markdownIt-Anchor" href="#jenkins集成sonarqube"></a> Jenkins集成Sonarqube</h2>
<ul>
<li>[Analyzing with SonarQube Scanner for Jenkins](Analyzing with SonarQube Scanner for Jenkins)</li>
</ul>
<p><strong>Reference</strong></p>
<ul>
<li><a href="https://jimmysong.io/kubernetes-handbook/practice/using-ceph-for-persistent-storage.html" target="_blank" rel="noopener">使用Ceph做持久化存储创建MySQL集群</a></li>
<li><a href="http://rancher.com/running-highly-available-wordpress-mysql-kubernetes/" target="_blank" rel="noopener">Running Highly Available WordPress with MySQL on Kubernetes</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/examples/volumes/nfs" target="_blank" rel="noopener">NFS PV©</a></li>
</ul>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="https://acquaai.github.io">Acqua</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="https://acquaai.github.io/2018/03/23/sonar/">https://acquaai.github.io/2018/03/23/sonar/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/03/26/linuxperf/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Linux性能分析</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    
    
      <a class="next" href="/2018/03/13/ceph-cluster/">
        <span class="next-text nav-default">Ceph Distributed Storage System</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:acqua.young@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/acquaai" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      <a href="https://acquaai.github.io/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2019

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Acqua</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  <script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://acquaai.github.io/2018/03/23/sonar/';
        this.page.identifier = '2018/03/23/sonar/';
        this.page.title = 'SonarQube on Kubernetes';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//acquaai.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script>




    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->

  </body>
</html>
